<!DOCTYPE html>
<html>
    <head>
        <title>Hochrechnung COVID-19 Impfrate Deutschland</title>

        <meta charset="UTF-8">
        <meta name="description" content="Hochrechnung COVID-19 Impfrate Deutschland. Zeigt die verbleibende Zeit bis zur 80%igen Durchimpfung Deutschlands.">
        <meta name="keywords" content="Hochrechnung, COVID-19, Impfrate, Deutschland, Impfungen, Wann, durchgeimpft, Ende, Corona, Schaetzung, Timer, Ticker, Countdown">
        <meta name="author" content="Patrick Waldschmitt">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js" integrity="sha384-MV8AwEgYXLMw5ZPj4763CSPk+tYGoUZGdwr/+EfkAZ1Dl2rGHxOMpQ1IW7VtyUPn" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0" integrity="sha384-QzN1ywg2QLsf72ZkgRHgjkB/cfI4Dqjg6RJYQUqH6Wm8qp/MvmEYn+2NBsLnhLkr" crossorigin="anonymous"></script>

        <style>
            #timeLeftFat {
                font-size: 2em;
                font-weight: bold;
            }

            .timeLeftFatContainer {
                padding: 2em;
            }
        </style>
    </head>

    <body>
    <div class="container">


        <div class="container text-center w-100 timeLeftFatContainer">
            <div class="timeLeftFatContainer">
                <label>Gesch&auml;tzte verbleibende Zeit bis zur 80%igen Durchimpfung Deutschlands bei linear steigender Impfrate</label>
                <div id="timeLeftFat"></div>
                <br/>
                <br/>
                <div>Basierend auf den Daten des RKI: <a href="https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html">https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html</a></div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <canvas  id="vacChart"> </canvas>
            </div>
        </div>

        <div class="container">
            <h3>Aktueller Stand (RKI, <span id="updateDate"></span>)</h3>
            <div class="container p-2">
                <div class="row">
                    <label class="col-6">Bevoelkerung Deutschlands:</label>
                    <div class="col-6 text-right" id="population"></div>
                </div>
                <div class="row">
                    <label class="col-6">Summe der verabreichten Impfungen:</label>
                    <div class="col-6 text-right" id="sumVac"></div>
                </div>
                <div class="row">
                    <label class="col-6">Durchschnittliche Impfrate (7-Tage-Wert):</label>
                    <div class="col-6 text-right" id="avgVac"></div>
                </div>
                <div class="row">
                    <label class="col-6">Mittlere Steigerungsrate der Impfungen (7-Tage-Wert):</label>
                    <div class="col-6 text-right" id="avgVacInc7Days"></div>
                </div>
                <div class="row">
                    <label class="col-6">Mittlere Steigerungsrate der Impfungen (Mittelwert &uuml;ber alle Daten):</label>
                    <div class="col-6 text-right" id="avgVacInc"></div>
                </div>
            </div>
        </div>

        <div class="container">
            <h3>Annahmen</h3>
            <div class="container p-2">
                <div class="row">
                    <label class="col-6">Durchimpfung Deutschlands (gesch&auml;tzt 80% x 2 Dosen) erreicht bei:</label>
                    <div class="col-6 text-right" id="required"></div>
                </div>
                <div class="row">
                    <label class="col-6">Gesch&auml;tzte maximale Impfkapazitaet pro Tag (<a href="https://kommunal.de/impfzentren-Standorte">bei ca 460 Impfzentren</a>):</label>
                    <div class="col-6 text-right" id="maxVac"></div>
                </div>
            </div>
        </div>

        <div class="container">
            <h3>Hochrechnung</h3>

            <div class="container p-2">
                <h5>Konstante Impfrate (7-Tage-Wert)</h5>
                <div class="row">
                    <label class="col-6">80%igen Durchimpfung Deutschlands erreicht am:</label>
                    <div class="col-6 text-right" id="goalDate"></div>
                </div>
                <div class="row">
                    <label class="col-6">Verbleibende Zeit bis zur 80%igen Durchimpfung Deutschlands:</label>
                    <div class="col-6 text-right" id="timeLeft"></div>
                </div>
            </div>

            <div class="container p-2">
                <h5>Linear ansteigende Impfrate (Mittelwert &uuml;ber alle Daten)</h5>
                <div class="row">
                    <label class="col-6">80%igen Durchimpfung Deutschlands erreicht am:</label>
                    <div class="col-6 text-right" id="goalDateInc"></div>
                </div>
                <div class="row">
                    <label class="col-6">Verbleibende Zeit bis zur 80%igen Durchimpfung Deutschlands:</label>
                    <div class="col-6 text-right" id="timeLeftInc"></div>
                </div>
            </div>

        </div>
        <br/>
        <br/>
        <br/>
        <div class="container">
            <h3>Disclaimer</h3>
            <div class="container p-2">
                <p>Bei den Hochrechnungen handelt es sich um sehr einfache Modelle, die hoechstens eine qualitative Abschaetzung ermoeglichen.</p>
                <p>Die Durchimpfung Deutschlands wurde fuer die Berechnungen auf einen Wert festgesetzt, der bei Impfung von 80% der Bevoelkerung erreicht ist. Bei diesem Wert handelt es sich um eine grobe Schaetzung. Der Wert fundiert nicht auf recherchierten wissenschaftlichen Erkenntnissen.</p>
                <p>Fuer die Korrektheit der Daten kann ich nicht garantieren und uebernehme dafuer keine Haftung.</p>
                <p>Fuer den Inhalt der verlinkten Seiten uebernehme ich keine Haftung.</p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        <!--
        var ctx = document.getElementById('vacChart').getContext('2d');

        // https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html


        let rkiDateFormat = 'YYYY-MM-DD';
        let outputFormat = 'DD MMM YYYY';
        let chartDataRki = [];
        let chartDataRkiSecondVac = [];

        let chartIncEstimation = [];

        let population = 83020000;
        let goalPercentage = 80.0 * 2.0;
        let maxVacsPerDay = 460000;
        let chart = null;

        function sumVaccinations() {
            let sum = 0;
            for(let index = 0; index < chartDataRki.length; index++) {
                sum += chartDataRki[index].y;
            }
            return sum;
        }

        function areaBelowGraph(days) {
            let dayRange = Math.min(days,chartDataRki.length);
            let sum = 0;
            for( i = 0; i < dayRange; i++) {
                let previousDayIndex = chartDataRki.length-2-i;
                let previousDay = 0;
                if( previousDayIndex >= 0) {
                    previousDay = chartDataRki[previousDayIndex].y;
                }

                let currentDayIndex = chartDataRki.length-1-i;
                let currentDay = chartDataRki[currentDayIndex].y;

                let area = currentDay + ((currentDay-previousDay) /2.0);
                sum += area;
            }
            return sum;
        }

        function avgAreaIncreasePerDay(days) {
            let area = areaBelowGraph(days);
            let lastDayValue = (area * 2.0) / chartDataRki.length;
            return lastDayValue / chartDataRki.length;
        }

        function calcLinearChartDataByArea() {
            let avgInc = avgAreaIncreasePerDay(chartDataRki.length);

            let chartDateInc = [];
            for(let index=0; index < chartDataRki.length; index++) {
                chartDateInc.push({x:chartDataRki[index].x, y:(avgInc*(index))});
            }
            return chartDateInc;
        }

        function avgVaccinationsPerDay(days) {
            let weekDays = Math.min(days,chartDataRki.length);
            let lastIndex = chartDataRki.length - 1;
            let sum = 0;
            for( i=0; i < weekDays; i++) {
                sum += chartDataRki[lastIndex - i].y;
            }
            return sum / weekDays;
        }

        function avgVaccinationsPerSecond(dailyRate) {
            return dailyRate / (24 * 60 * 60)
        }

        function remainingVaccinations(goalPercentage) {
            return (population * goalPercentage/100) - sumVaccinations();
        }

        function getLastMeassuredMoment() {
            return moment(chartDataRki[chartDataRki.length-1].x, rkiDateFormat).add(1, 'd').startOf('day')
        }

        function getLastMeassuredValue() {
            return chartDataRki[chartDataRki.length-1].y
        }

        function readableDiff(start, end){
            var years = end.diff(start, 'years')
            end = end.add(-years, 'years');
            var months = end.diff(start, 'months')
            end = end.add(-months, 'months');
            var days = end.diff(start, 'days')
            end = end.add(-days, 'days');
            var hours = end.diff(start, 'hours')
            end = end.add(-hours, 'hours');
            var minutes = end.diff(start, 'minutes')
            end = end.add(-minutes, 'minutes');
            var seconds = end.diff(start, 'seconds')
            //end = end.add(-seconds, 'seconds');

            var text = days+' Tage  '+hours+' Stunden  '+minutes+' Minuten  '+seconds+' Sekunden';
            if(months) {
                text = months+' Monate  ' + text
            }
            if(years) {
                text = years+' Jahre  ' + text
            }
            return text;
        }

        function calcTimeToGoFromNow(goalMoment) {
            var now = moment();
            var end = goalMoment.clone();
            return readableDiff(now, end);
        }

        // constant rate

        function daysTillGoal(dailyRate, goalPercentage) {
            return remainingVaccinations(goalPercentage) / dailyRate;
        }

        function calcGoalMoment(dailyRate, goalPercentage) {
            var days = daysTillGoal(dailyRate, goalPercentage)
            return moment().startOf('day').add(days, 'd')
        }


        // linear rate

        function daysTillGoalLinear(dailyRate, dailyInc, goalPercentage) {
            var now = getLastMeassuredMoment().add(-1,'d').startOf('day');
            var days = 0;
            var startingValue = (chartDataRki.length-1) * dailyInc;
            var sum = startingValue;
            var max = (population * goalPercentage/100.0);
            while(sum < max) {
                var rate = Math.min(startingValue + (days*dailyInc), maxVacsPerDay);
                sum += rate;
                if(days < 100) {
                    chartIncEstimation.push({x: now.format(rkiDateFormat), y: rate})
                }
                now.add(1, 'd');
                days++;
            }
            return days;
        }

        function calcGoalMomentLinear(dailyRate, dailyInc, goalPercentage) {
            var days = daysTillGoalLinear(dailyRate, dailyInc, goalPercentage)
            return moment().startOf('day').add(days, 'd')
        }

        function updatePage() {
            // facts
            document.getElementById('population').textContent = population;
            document.getElementById('required').textContent = remainingVaccinations(goalPercentage);
            document.getElementById('sumVac').textContent = sumVaccinations();
            document.getElementById('avgVac').textContent = Math.floor(avgVaccinationsPerDay(7));
            document.getElementById('avgVacInc7Days').textContent = Math.floor(avgAreaIncreasePerDay(7));
            document.getElementById('avgVacInc').textContent = Math.floor(avgAreaIncreasePerDay(chartDataRki.length));
            document.getElementById('updateDate').textContent = getLastMeassuredMoment().format(outputFormat);

            // estimated
            var dailyRate = avgVaccinationsPerDay(7);
            var dailyInc = avgAreaIncreasePerDay(chartDataRki.length);

            let goalMoment = calcGoalMoment(dailyRate, goalPercentage);
            document.getElementById('goalDate').textContent = goalMoment.format(outputFormat);

            let goalMomentInc = calcGoalMomentLinear(dailyRate, dailyInc, goalPercentage);
            document.getElementById('goalDateInc').textContent = goalMomentInc.format(outputFormat);

            document.getElementById('maxVac').textContent = maxVacsPerDay;

            function tick() {
                var timeLeft = calcTimeToGoFromNow(goalMoment);
                document.getElementById('timeLeft').textContent = timeLeft;

                var timeLeftInc = calcTimeToGoFromNow(goalMomentInc);
                document.getElementById('timeLeftInc').textContent = timeLeftInc;


                document.getElementById('timeLeftFat').textContent = timeLeftInc;
            }

            tick();

            window.setInterval(function () {
                tick();
            }, 1000);


            chart = new Chart(ctx, {
                // The type of chart we want to create
                type: 'line',

                // The data for our dataset
                data: {
                    datasets: [
                        {
                            label: 'Mittlere Steigerungsrate (komplette Zeit)',
                            backgroundColor: 'rgba(157,181,203)',
                            borderColor: 'rgba(6,100,215)',
                            fill: false,
                            data: calcLinearChartDataByArea()
                        },
                        {
                            label: 'Zweit-Impfungen pro Tag (Stand RKI)',
                            backgroundColor: 'rgb(123,179,102)',
                            borderColor: 'rgb(64,140,13)',
                            data: chartDataRkiSecondVac
                        },
                        {
                            label: 'Impfungen pro Tag (Stand RKI)',
                            backgroundColor: 'rgb(212,231,205)',
                            borderColor: 'rgb(91,183,29)',
                            data: chartDataRki
                        },
                        {
                            label: 'Hochrechnung: linear',
                            backgroundColor: 'rgb(233,213,233)',
                            borderColor: 'rgb(176,87,226)',
                            fill: true,
                            data: chartIncEstimation
                        }
                    ]
                },

                // Configuration options go here
                options: {
                    scales: {
                        xAxes: [{
                            type: 'time',
                            time: {
                                parser: rkiDateFormat,
                                unit: 'day'
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Datum'
                            }
                        }],
                        yAxes: [{
                            scaleLabel: {
                                display: true,
                                labelString: 'Impfungen pro Tag'
                            }
                        }]
                    }
                }
            });
        }

        //read data from tsv
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (xhttp.readyState === 4 && xhttp.status === 200) {
                let lines = xhttp.responseText.trim().split('\n');
                let secondVacPreviousDay = 0;
                for(let lineIndex=1; lineIndex< lines.length; lineIndex++) {
                    let line = lines[lineIndex];
                    let dataset = line.split('\t');
                    if(lineIndex === 1) {
                        //add first day with zero vacs
                        let dayZero = moment(dataset[0], rkiDateFormat).add(-1,'d').format(rkiDateFormat)
                        chartDataRki.push({x: dayZero, y: 0});
                    }
                    chartDataRki.push({x: dataset[0], y: parseInt(dataset[2])});

                    //second vac personen_voll_kumulativ
                    let secondVacCurrentDay = parseInt(dataset[6]);
                    let secondVacDiff = secondVacCurrentDay - secondVacPreviousDay;
                    if(secondVacCurrentDay !== 0) {
                        if(secondVacPreviousDay === 0) {
                            //add first day with zero vacs
                            let dayZero = moment(dataset[0], rkiDateFormat).add(-1,'d').format(rkiDateFormat)
                            chartDataRkiSecondVac.push({x: dayZero, y: 0})
                        }
                        chartDataRkiSecondVac.push({x: dataset[0], y: secondVacDiff})
                    }
                    secondVacPreviousDay = secondVacCurrentDay;
                }
                updatePage();
            }

        };
        //unable to load file directly into webapp because of CORS: https://impfdashboard.de/static/data/germany_vaccinations_timeseries_v2.tsv
        xhttp.open("GET", "./germany_vaccinations_timeseries_v2.tsv", true);
        //xhttp.open("GET", "https://impfdashboard.de/static/data/germany_vaccinations_timeseries_v2.tsv", true);
        xhttp.send();
        //-->
    </script>
    </body>
</html>