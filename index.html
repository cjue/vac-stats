<html>
    <head>
        <title>COVID-19 Impfquote Deutschland</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

        <style>
            #timeLeftFat {
                font-size: 2em;
                font-weight: bold;
            }

            .timeLeftFatContainer {
                padding: 2em;
            }
        </style>
    </head>

    <body>
    <div class="container">
        <h1>COVID-19 Impfquote Deutschland</h1>

        Basierend auf den Daten des RKI: <a href="https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html">https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html</a>

        <div class="container text-center w-100 timeLeftFatContainer">
            <div class="timeLeftFatContainer">
                <label>Verbleibende Zeit bis zur Herdenimmunit&auml;t (70%)</label>
                <div id="timeLeftFat"></div>
            </div>
        </div>
        <div class="container">
            <h3>Aktueller Stand (RKI, <span id="updateDate"></span>)</h3>
            <div class="row">
                <label class="col-6">Bevoelkerung Deutschlands:</label>
                <div class="col-6 text-right" id="population"></div>
            </div>
            <div class="row">
                <label class="col-6">Herdenimmunitaet (70%) erreicht bei:</label>
                <div class="col-6 text-right" id="required"></div>
            </div>
            <div class="row">
                <label class="col-6">Bereits geimpft (letzter Stand RKI)</label>
                <div class="col-6 text-right" id="sumVac"></div>
            </div>
            <div class="row">
                <label class="col-6">Impfungen pro Tag (7-Tage-Schnitt):</label>
                <div class="col-6 text-right" id="avgVac"></div>
            </div>
            <br/>
            <h5>Details</h5>
            <div class="row">
                <label class="col-6">Mittlere Steigerungsrate der Impfungen (7-Tage-Schnitt):</label>
                <div class="col-6 text-right" id="avgVacInc7Days"></div>
            </div>
            <div class="row">
                <label class="col-6">Mittlere Steigerungsrate der Impfungen (komplette Zeit):</label>
                <div class="col-6 text-right" id="avgVacInc"></div>
            </div>
            <div class="row">
                <div class="col-12">
                    <canvas  id="vacChart"> </canvas>
                </div>
            </div>
        </div>

        <div class="container">
            <h3>Hochrechnung Details</h3>
            <div class="row">
                <label class="col-6">Herdenimmunitaet (70%) erreicht am:</label>
                <div class="col-6 text-right" id="goalDate"></div>
            </div>
            <div class="row">
                <label class="col-6">Verbleibende Impfungen:</label>
                <div class="col-6 text-right" id="vacsLeft"></div>
            </div>
            <div class="row">
                <label class="col-6">Verbleibende Zeit bis zur Herdenimmunit&auml;t:</label>
                <div class="col-6 text-right" id="timeLeft"></div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        <!--
        var ctx = document.getElementById('vacChart').getContext('2d');

        // https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html


        var rkiDateFormat = 'DD/MM/YYYY'
        var outputFormat = 'DD MMM YYYY'
        var chartDataRki = [
            { x:"27/12/2020" ,	y:24008},
            { x:"28/12/2020" ,	y:19232},
            { x:"29/12/2020" ,	y:42431},
            { x:"30/12/2020" ,	y:57070},
            { x:"31/12/2020" ,	y:37766},
            { x:"01/01/2021" ,	y:30375},
            { x:"02/01/2021" ,	y:44549},
            { x:"03/01/2021" ,	y:24366},
            { x:"04/01/2021" ,	y:47910},
            { x:"05/01/2021" ,	y:50099},
            { x:"06/01/2021" ,	y:55435},
            { x:"07/01/2021" ,	y:55957},
            { x:"08/01/2021" ,	y:57150},
            { x:"09/01/2021" ,	y:53491},
            { x:"10/01/2021" ,	y:32340},
            { x:"11/01/2021" ,	y:64370},
            { x:"12/01/2021" ,	y:78937},
            { x:"13/01/2021" ,	y:91542},
            { x:"14/01/2021" ,	y:94654}
        ]

        var population = 83020000;
        var goalPercentage = 70.0;
        var maxVacsPerDay = 250000;

        function sumVaccinations() {
            var sum = 0
            chartDataRki.forEach(item => {
                sum += item.y;
            })
            return sum
        }

        function avgIncreasePerDay(days) {
            let weekDays = Math.min(days,chartDataRki.length);
            let lastIndex = chartDataRki.length - 1;
            let sum = 0;
            for( i=0; i < weekDays; i++) {
                let previousDay = 0;
                let previousDayIndex = lastIndex-1-i;
                if( previousDayIndex >= 0) {
                    previousDay = chartDataRki[previousDayIndex].y;
                }
                let currentDay = chartDataRki[lastIndex-i].y;
                let increase = currentDay-previousDay;
                sum += increase;
            }
            return sum / weekDays;
        }

        function calcIncChartData() {
            let avgInc = avgIncreasePerDay(chartDataRki.length);
            let chartDateInc = [];
            chartDataRki.forEach((item,index) => {
                chartDateInc.push({x:item.x, y:(avgInc*(index+1))});
            })
            return chartDateInc;
        }

        function avgVaccinationsPerDay(days) {
            let weekDays = Math.min(days,chartDataRki.length);
            let lastIndex = chartDataRki.length - 1;
            let sum = 0;
            for( i=0; i < weekDays; i++) {
                sum += chartDataRki[lastIndex - i].y;
            }
            return sum / weekDays;
        }

        function remainingVaccinations(goalPercentage) {
            return (population * goalPercentage/100) - sumVaccinations();
        }

        function daysTillGoal(dailyRate, goalPercentage) {
            return remainingVaccinations(goalPercentage) / dailyRate;
        }

        function getLastMeassuredMoment() {
            return moment(chartDataRki[chartDataRki.length-1].x, rkiDateFormat).add(1, 'd').startOf('day')
        }

        function calcVacsToGoFromNow(dailyRate, goalPercentage) {
            var start = getLastMeassuredMoment()
            var now = moment()
            var secondRate = avgVaccinationsPerSecond(dailyRate)
            return Math.floor(remainingVaccinations(goalPercentage) - (now.diff(start, 'seconds') * secondRate))
        }

        function calcTimeToGoFromNow(dailyRate, goalPercentage) {
            var now = moment()
            var end = calcGoalMoment(dailyRate, goalPercentage)
            var years = end.diff(now, 'years')
            end = end.add(-years, 'years');
            var months = end.diff(now, 'months')
            end = end.add(-months, 'months');
            var days = end.diff(now, 'days')
            end = end.add(-days, 'days');
            var hours = end.diff(now, 'hours')
            end = end.add(-hours, 'hours');
            var minutes = end.diff(now, 'minutes')
            end = end.add(-minutes, 'minutes');
            var seconds = end.diff(now, 'seconds')
            end = end.add(-seconds, 'seconds');
            return years+' years  '+months+' months  '+days+' days  '+hours+' hours  '+minutes+' minutes  '+seconds+' seconds  '
        }

        function calcGoalMoment(dailyRate, goalPercentage) {
            var days = daysTillGoal(dailyRate, goalPercentage)
            return moment().startOf('day').add(days, 'd')
        }

        function avgVaccinationsPerSecond(dailyRate) {
            return dailyRate / (24 * 60 * 60)
        }


        var dailyRate = avgVaccinationsPerDay(7);

        document.getElementById('population').textContent = population;
        document.getElementById('required').textContent = remainingVaccinations(goalPercentage);
        document.getElementById('sumVac').textContent = sumVaccinations();
        document.getElementById('avgVac').textContent = Math.floor(avgVaccinationsPerDay(7));
        document.getElementById('avgVacInc7Days').textContent = Math.floor(avgIncreasePerDay(7));
        document.getElementById('avgVacInc').textContent = Math.floor(avgIncreasePerDay(chartDataRki.length));
        document.getElementById('goalDate').textContent = calcGoalMoment(dailyRate, goalPercentage).format(outputFormat);
        document.getElementById('updateDate').textContent = getLastMeassuredMoment().format(outputFormat);

        function tick() {
            var timeLeft = calcTimeToGoFromNow(dailyRate, goalPercentage);
            document.getElementById('timeLeft').textContent = timeLeft;
            document.getElementById('vacsLeft').textContent = calcVacsToGoFromNow(dailyRate, goalPercentage);
            document.getElementById('timeLeftFat').textContent = timeLeft;
        }

        tick();

        window.setInterval(function(){
            tick();
        }, 1000);


        var chart = new Chart(ctx, {
            // The type of chart we want to create
            type: 'line',

            // The data for our dataset
            data: {
                datasets: [
                    {
                        label: 'Mittlere Steigerungsrate (komplette Zeit)',
                        backgroundColor: 'rgb(157,181,203)',
                        borderColor: 'rgb(6,100,215)',
                        fill: false,
                        data: calcIncChartData()
                    },
                    {
                        label: 'Impfungen pro Tag',
                        backgroundColor: 'rgb(212,231,205)',
                        borderColor: 'rgb(91,183,29)',
                        data: chartDataRki
                    }
                ]
            },

            // Configuration options go here
            options: {
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            parser: rkiDateFormat,
                            unit: 'day'
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Datum'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Impfungen pro Tag'
                        }
                    }]
                }
            }
        });
        //-->
    </script>
    </body>
</html>