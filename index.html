<!DOCTYPE html>
<html>
    <head>
        <title>Hochrechnung COVID-19 Impfquote Deutschland</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js" integrity="sha384-MV8AwEgYXLMw5ZPj4763CSPk+tYGoUZGdwr/+EfkAZ1Dl2rGHxOMpQ1IW7VtyUPn" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0" integrity="sha384-QzN1ywg2QLsf72ZkgRHgjkB/cfI4Dqjg6RJYQUqH6Wm8qp/MvmEYn+2NBsLnhLkr" crossorigin="anonymous"></script>

        <style>
            #timeLeftFat {
                font-size: 2em;
                font-weight: bold;
            }

            .timeLeftFatContainer {
                padding: 2em;
            }
        </style>
    </head>

    <body>
    <div class="container">


        <div class="container text-center w-100 timeLeftFatContainer">
            <div class="timeLeftFatContainer">
                <label>Gesch&auml;tzte verbleibende Zeit bis zur Herdenimmunit&auml;t (70%) bei linear steigender Impfquote</label>
                <div id="timeLeftFat"></div>
                <br/>
                <br/>
                <div>Basierend auf den Daten des RKI: <a href="https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html">https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html</a></div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <canvas  id="vacChart"> </canvas>
            </div>
        </div>

        <div class="container">
            <h3>Aktueller Stand (RKI, <span id="updateDate"></span>)</h3>
            <div class="container p-2">
                <div class="row">
                    <label class="col-6">Bevoelkerung Deutschlands:</label>
                    <div class="col-6 text-right" id="population"></div>
                </div>
                <div class="row">
                    <label class="col-6">Herdenimmunitaet (70% x 2 Dosen) erreicht bei:</label>
                    <div class="col-6 text-right" id="required"></div>
                </div>
                <div class="row">
                    <label class="col-6">Impfungen verabreicht:</label>
                    <div class="col-6 text-right" id="sumVac"></div>
                </div>
                <div class="row">
                    <label class="col-6">Impfquote (7-Tage-Wert):</label>
                    <div class="col-6 text-right" id="avgVac"></div>
                </div>
                <div class="row">
                    <label class="col-6">Mittlere Steigerungsrate der Impfungen (7-Tage-Wert):</label>
                    <div class="col-6 text-right" id="avgVacInc7Days"></div>
                </div>
                <div class="row">
                    <label class="col-6">Mittlere Steigerungsrate der Impfungen (Mittelwert &uuml;ber alle Daten):</label>
                    <div class="col-6 text-right" id="avgVacInc"></div>
                </div>
            </div>
        </div>

        <div class="container">
            <h3>Hochrechnung</h3>

            <div class="container p-2">
                <h5>Konstante Impfquote (7-Tage-Wert)</h5>
                <div class="row">
                    <label class="col-6">Herdenimmunitaet (70%) erreicht am:</label>
                    <div class="col-6 text-right" id="goalDate"></div>
                </div>
                <div class="row">
                    <label class="col-6">Verbleibende Zeit bis zur Herdenimmunit&auml;t:</label>
                    <div class="col-6 text-right" id="timeLeft"></div>
                </div>
            </div>

            <div class="container p-2">
                <h5>Linear ansteigende Impfquote (Mittelwert &uuml;ber alle Daten)</h5>
                <div class="row">
                    <label class="col-6">Maximale Impfkapazitaet pro Tag (ca 460 Impfzentren):</label>
                    <div class="col-6 text-right" id="maxVac"></div>
                </div>
                <div class="row">
                    <label class="col-6">Herdenimmunitaet (70%) erreicht am:</label>
                    <div class="col-6 text-right" id="goalDateInc"></div>
                </div>
                <div class="row">
                    <label class="col-6">Verbleibende Zeit bis zur Herdenimmunit&auml;t:</label>
                    <div class="col-6 text-right" id="timeLeftInc"></div>
                </div>
            </div>

        </div>
        <br/>
        <br/>
        <br/>
        <div class="container">
            <h3>Disclaimer</h3>
            <div class="container p-2">
                <p>Bei den Hochrechnungen handelt es sich um sehr einfache Modelle, die hoechstens eine qualitative Abschaetzung ermoeglichen.</p>
                <p>Die Herdenimmunitaet wurde fuer die Berechnungen auf einen Wert festgesetzt, der bei Impfung von 70% der Bevoelkerung erreicht ist. Bei diesem Wert handelt es sich um eine grobe Schaetzung. Der Wert fundiert nicht auf recherchierten Wissenschaftlichen Erkenntnissen.</p>
                <p>Fuer die Korrektheit der Daten kann ich nicht garantieren und uebernehme dafuer keine Haftung.</p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        <!--
        var ctx = document.getElementById('vacChart').getContext('2d');

        // https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html


        var rkiDateFormat = 'DD/MM/YYYY'
        var outputFormat = 'DD MMM YYYY'
        var chartDataRki = [
            { x:"27/12/2020" ,	y:24080},
            { x:"28/12/2020" ,	y:19501},
            { x:"29/12/2020" ,	y:42692},
            { x:"30/12/2020" ,	y:57228},
            { x:"31/12/2020" ,	y:37830},
            { x:"01/01/2021" ,	y:30531},
            { x:"02/01/2021" ,	y:44740},
            { x:"03/01/2021" ,	y:24518},
            { x:"04/01/2021" ,	y:48316},
            { x:"05/01/2021" ,	y:50520},
            { x:"06/01/2021" ,	y:55682},
            { x:"07/01/2021" ,	y:56633},
            { x:"08/01/2021" ,	y:57329},
            { x:"09/01/2021" ,	y:53433},
            { x:"10/01/2021" ,	y:32233},
            { x:"11/01/2021" ,	y:65457},
            { x:"12/01/2021" ,	y:79417},
            { x:"13/01/2021" ,	y:92944},
            { x:"14/01/2021" ,	y:97788},
            { x:"15/01/2021" ,  y:85175+55},
            { x:"16/01/2021" ,  y:52098+62},
            { x:"17/01/2021" ,  y:31152+6.464}
        ];

        var chartIncEstimation = [];

        var population = 83020000;
        var goalPercentage = 70.0 * 2.0;
        var maxVacsPerDay = 460000;

        function sumVaccinations() {
            var sum = 0
            chartDataRki.forEach(item => {
                sum += item.y;
            })
            return sum
        }

        function avgIncreasePerDay(days) {
            let weekDays = Math.min(days,chartDataRki.length);
            let lastIndex = chartDataRki.length - 1;
            let sum = 0;
            for( i=0; i < weekDays; i++) {
                let previousDay = 0;
                let previousDayIndex = lastIndex-1-i;
                if( previousDayIndex >= 0) {
                    previousDay = chartDataRki[previousDayIndex].y;
                }
                let currentDay = chartDataRki[lastIndex-i].y;
                let increase = currentDay-previousDay;
                sum += increase;
            }
            return sum / weekDays;
        }

        function calcIncChartData() {
            let avgInc = avgIncreasePerDay(chartDataRki.length);
            let chartDateInc = [];
            chartDataRki.forEach((item,index) => {
                chartDateInc.push({x:item.x, y:(avgInc*(index+1))});
            })
            return chartDateInc;
        }

        function avgVaccinationsPerDay(days) {
            let weekDays = Math.min(days,chartDataRki.length);
            let lastIndex = chartDataRki.length - 1;
            let sum = 0;
            for( i=0; i < weekDays; i++) {
                sum += chartDataRki[lastIndex - i].y;
            }
            return sum / weekDays;
        }

        function avgVaccinationsPerSecond(dailyRate) {
            return dailyRate / (24 * 60 * 60)
        }

        function remainingVaccinations(goalPercentage) {
            return (population * goalPercentage/100) - sumVaccinations();
        }

        function getLastMeassuredMoment() {
            return moment(chartDataRki[chartDataRki.length-1].x, rkiDateFormat).add(1, 'd').startOf('day')
        }

        function getLastMeassuredValue() {
            return chartDataRki[chartDataRki.length-1].y
        }

        function readableDiff(start, end){
            var years = end.diff(start, 'years')
            end = end.add(-years, 'years');
            var months = end.diff(start, 'months')
            end = end.add(-months, 'months');
            var days = end.diff(start, 'days')
            end = end.add(-days, 'days');
            var hours = end.diff(start, 'hours')
            end = end.add(-hours, 'hours');
            var minutes = end.diff(start, 'minutes')
            end = end.add(-minutes, 'minutes');
            var seconds = end.diff(start, 'seconds')
            //end = end.add(-seconds, 'seconds');

            var text = days+' days  '+hours+' hours  '+minutes+' minutes  '+seconds+' seconds';
            if(months) {
                text = months+' months  ' + text
            }
            if(years) {
                text = years+' years  ' + text
            }
            return text;
        }

        function calcTimeToGoFromNow(goalMoment) {
            var now = moment();
            var end = goalMoment.clone();
            return readableDiff(now, end);
        }

        // constant rate

        function daysTillGoal(dailyRate, goalPercentage) {
            return remainingVaccinations(goalPercentage) / dailyRate;
        }

        function calcGoalMoment(dailyRate, goalPercentage) {
            var days = daysTillGoal(dailyRate, goalPercentage)
            return moment().startOf('day').add(days, 'd')
        }


        // linear rate

        function daysTillGoalInc(dailyRate, dailyInc, goalPercentage) {
            var now = getLastMeassuredMoment().add(-1, 'd').startOf('day');
            var days = 0;
            var startingValue = getLastMeassuredValue();
            var sum = startingValue;
            var max = (population * goalPercentage/100.0);
            while(sum < max) {
                var rate = Math.min(startingValue + (days*dailyInc), maxVacsPerDay);
                sum += rate;
                if(days < 100) {
                    chartIncEstimation.push({x: now.format(rkiDateFormat), y: rate})
                }
                now.add(1, 'd');
                days++;
            }
            return days;
        }

        function calcGoalMomentInc(dailyRate, dailyInc, goalPercentage) {
            var days = daysTillGoalInc(dailyRate, dailyInc, goalPercentage)
            return moment().startOf('day').add(days, 'd')
        }


        // facts
        document.getElementById('population').textContent = population;
        document.getElementById('required').textContent = remainingVaccinations(goalPercentage);
        document.getElementById('sumVac').textContent = sumVaccinations();
        document.getElementById('avgVac').textContent = Math.floor(avgVaccinationsPerDay(7));
        document.getElementById('avgVacInc7Days').textContent = Math.floor(avgIncreasePerDay(7));
        document.getElementById('avgVacInc').textContent = Math.floor(avgIncreasePerDay(chartDataRki.length));
        document.getElementById('updateDate').textContent = getLastMeassuredMoment().format(outputFormat);

        // estimated
        var dailyRate = avgVaccinationsPerDay(7);
        var dailyInc = avgIncreasePerDay(chartDataRki.length);

        let goalMoment=calcGoalMoment(dailyRate, goalPercentage);
        document.getElementById('goalDate').textContent = goalMoment.format(outputFormat);

        let goalMomentInc=calcGoalMomentInc(dailyRate, dailyInc, goalPercentage);
        document.getElementById('goalDateInc').textContent = goalMomentInc.format(outputFormat);

        document.getElementById('maxVac').textContent = maxVacsPerDay;

        function tick() {
            var timeLeft = calcTimeToGoFromNow(goalMoment);
            document.getElementById('timeLeft').textContent = timeLeft;

            var timeLeftInc = calcTimeToGoFromNow(goalMomentInc);
            document.getElementById('timeLeftInc').textContent = timeLeftInc;


            document.getElementById('timeLeftFat').textContent = timeLeftInc;
        }

        tick();

        window.setInterval(function(){
            tick();
        }, 1000);


        var chart = new Chart(ctx, {
            // The type of chart we want to create
            type: 'line',

            // The data for our dataset
            data: {
                datasets: [
                    {
                        label: 'Mittlere Steigerungsrate (komplette Zeit)',
                        backgroundColor: 'rgba(157,181,203)',
                        borderColor: 'rgba(6,100,215)',
                        fill: false,
                        data: calcIncChartData()
                    },
                    {
                        label: 'Hochrechnung: linear',
                        backgroundColor: 'rgb(233,213,233)',
                        borderColor: 'rgb(176,87,226)',
                        fill: true,
                        data: chartIncEstimation
                    },
                    {
                        label: 'Impfungen pro Tag (Stand RKI)',
                        backgroundColor: 'rgb(212,231,205)',
                        borderColor: 'rgb(91,183,29)',
                        data: chartDataRki
                    }
                ]
            },

            // Configuration options go here
            options: {
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            parser: rkiDateFormat,
                            unit: 'day'
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Datum'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Impfungen pro Tag'
                        }
                    }]
                }
            }
        });
        //-->
    </script>
    </body>
</html>